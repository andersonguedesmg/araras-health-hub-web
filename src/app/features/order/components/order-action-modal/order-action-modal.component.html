<app-spinner [loading]="isLoading"></app-spinner>
<app-confirm-dialog></app-confirm-dialog>

<p-dialog
  [(visible)]="display"
  (onHide)="closeModal()"
  [modal]="true"
  [style]="{ width: '70vw' }"
  [draggable]="false"
  [resizable]="false"
  [header]="'Pedido #' + (order?.id || '')"
>
  <ng-container *ngIf="order">
    <div class="p-4 bg-zinc-900 rounded-b-xl">
      <form [formGroup]="actionForm">
        <div
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-8"
        >
          <div
            class="bg-zinc-800 p-6 rounded-lg shadow-md flex flex-col justify-between"
          >
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-base font-semibold text-white flex items-center">
                <i class="pi pi-book text-xl text-blue-400 mr-3"></i>
                Pedido
              </h3>
              <p-tag
                [value]="getOrderStatus(order.orderStatus.description)"
                [severity]="getOrderSeverity(order.orderStatus.description)"
                class="text-sm font-medium w-fit"
              />
            </div>

            <div class="space-y-3 text-gray-300 text-sm">
              <div>
                <label class="block text-gray-400">Data:</label>
                <p class="font-semibold">
                  {{ order.createdAt | date : "dd/MM/yyyy - HH:mm" }}
                </p>
              </div>
              <div class="truncate">
                <label class="block text-gray-400">Responsável:</label>
                <p class="font-semibold">
                  {{ order.createdByEmployee.name || "N/A" }}
                </p>
              </div>
            </div>
          </div>

          <div
            class="bg-zinc-800 p-6 rounded-lg shadow-md flex flex-col justify-between"
          >
            <h3
              class="text-base font-semibold text-white flex items-center mb-4"
            >
              <i class="pi pi-check text-xl text-green-400 mr-3"></i>
              Aprovação
            </h3>
            <div class="space-y-3 text-gray-300 text-sm">
              <div *ngIf="order.approvedAt; else noApprovalDate">
                <label class="block text-gray-400">Data:</label>
                <p class="font-semibold">
                  {{ order.approvedAt | date : "dd/MM/yyyy - HH:mm" }}
                </p>
              </div>
              <div *ngIf="order.approvedByEmployee?.name; else noApproval">
                <label class="block text-gray-400">Responsável:</label>
                <p class="font-semibold">{{ order.approvedByEmployee.name }}</p>
              </div>

              <div *ngIf="actionType === OrderActionType.Approve">
                <label class="block text-gray-400 mt-4">Responsável:</label>
                <p-select
                  [options]="responsibleEmployeeOptions"
                  formControlName="responsibleEmployeeId"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Selecione"
                  class="w-full"
                  [showClear]="true"
                  [filter]="true"
                  filterBy="label"
                  [ngClass]="{
                    'ng-invalid ng-dirty':
                      actionForm.get('responsibleEmployeeId')?.invalid &&
                      formSubmitted
                  }"
                />
              </div>
            </div>
          </div>

          <div
            class="bg-zinc-800 p-6 rounded-lg shadow-md flex flex-col justify-between"
          >
            <h3
              class="text-base font-semibold text-white flex items-center mb-4"
            >
              <i class="pi pi-list text-xl text-orange-400 mr-3"></i>
              Separação
            </h3>
            <div class="space-y-3 text-gray-300 text-sm">
              <div *ngIf="order.separatedAt; else noSeparationDate">
                <label class="block text-gray-400">Data:</label>
                <p class="font-semibold">
                  {{ order.separatedAt | date : "dd/MM/yyyy - HH:mm" }}
                </p>
              </div>
              <div *ngIf="order.separatedByEmployee?.name; else noSeparation">
                <label class="block text-gray-400">Responsável:</label>
                <p class="font-semibold">
                  {{ order.separatedByEmployee.name }}
                </p>
              </div>
              <div *ngIf="actionType === OrderActionType.Separate">
                <label class="block text-gray-400 mt-4">Responsável:</label>
                <p-select
                  [options]="responsibleEmployeeOptions"
                  formControlName="responsibleEmployeeId"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Selecione"
                  class="w-full"
                  [showClear]="true"
                  [filter]="true"
                  filterBy="label"
                  [ngClass]="{
                    'ng-invalid ng-dirty':
                      actionForm.get('responsibleEmployeeId')?.invalid &&
                      formSubmitted
                  }"
                />
              </div>
            </div>
          </div>

          <div
            class="bg-zinc-800 p-6 rounded-lg shadow-md flex flex-col justify-between"
          >
            <h3
              class="text-base font-semibold text-white flex items-center mb-4"
            >
              <i class="pi pi-box text-xl text-purple-400 mr-3"></i>
              Finalização
            </h3>
            <div class="space-y-3 text-gray-300 text-sm">
              <div *ngIf="order.finalizedAt; else noFinalizationDate">
                <label class="block text-gray-400">Data:</label>
                <p class="font-semibold">
                  {{ order.finalizedAt | date : "dd/MM/yyyy - HH:mm" }}
                </p>
              </div>
              <div *ngIf="order.finalizedByEmployee?.name; else noFinalization">
                <label class="block text-gray-400">Responsável:</label>
                <p class="font-semibold">
                  {{ order.finalizedByEmployee.name }}
                </p>
              </div>
              <div *ngIf="actionType === OrderActionType.Finalize">
                <label class="block text-gray-400 mt-4">Responsável:</label>
                <p-select
                  [options]="responsibleEmployeeOptions"
                  formControlName="responsibleEmployeeId"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Selecione"
                  class="w-full"
                  [showClear]="true"
                  [filter]="true"
                  filterBy="label"
                  [ngClass]="{
                    'ng-invalid ng-dirty':
                      actionForm.get('responsibleEmployeeId')?.invalid &&
                      formSubmitted
                  }"
                />
              </div>
            </div>
          </div>
        </div>

        <ng-template #noApproval
          ><p class="font-light text-gray-500">N/A</p></ng-template
        >
        <ng-template #noApprovalDate
          ><p class="font-light text-gray-500">N/A</p></ng-template
        >
        <ng-template #noSeparation
          ><p class="font-light text-gray-500">N/A</p></ng-template
        >
        <ng-template #noSeparationDate
          ><p class="font-light text-gray-500">N/A</p></ng-template
        >
        <ng-template #noFinalization
          ><p class="font-light text-gray-500">N/A</p></ng-template
        >
        <ng-template #noFinalizationDate
          ><p class="font-light text-gray-500">N/A</p></ng-template
        >

        <h2
          class="text-xl font-semibold text-white mb-4 mt-8 flex items-center"
        >
          <i class="pi pi-box mr-2 text-yellow-400"></i> Itens do Pedido
        </h2>

        <p-table
          [value]="orderItemsFormArray.controls"
          dataKey="id"
          [tableStyle]="{ 'min-width': '50rem' }"
        >
          <ng-template pTemplate="header">
            <tr>
              <th class="w-1/4">PRODUTO</th>
              <th class="w-1/5" *ngIf="actionType === OrderActionType.Approve">
                QTD. DISPONÍVEL
              </th>
              <th class="w-1/5">QTD. SOLICITADA</th>
              <th class="w-1/5">QTD. APROVADA</th>

              <ng-container *ngIf="actionType === OrderActionType.Separate">
                <th class="w-1/6">LOTE / VALIDADE</th>
                <th class="w-1/6">QTD. LOTE DISPONÍVEL</th>
              </ng-container>

              <th
                class="w-1/5"
                *ngIf="
                  actionType === OrderActionType.Separate ||
                  actionType === OrderActionType.Finalize ||
                  actionType === OrderActionType.Detail
                "
              >
                QTD. SEPARADA
              </th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-productFormGroup let-ri="rowIndex">
            <ng-container
              *ngIf="
                actionType === OrderActionType.Separate &&
                  getFormGroup(productFormGroup).get('lotsToSeparate')?.value
                    ?.length;
                else simpleProductRow
              "
            >
              <ng-container
                *ngFor="
                  let lotGroup of getLotsFormArray(productFormGroup).controls;
                  let lotIndex = index;
                  let isFirstLot = first
                "
              >
                <tr [formGroup]="getFormGroup(lotGroup)">
                  <td
                    *ngIf="isFirstLot"
                    [attr.rowspan]="
                      getLotsFormArray(productFormGroup).controls.length
                    "
                  >
                    {{
                      getFormGroup(productFormGroup).get("productName")?.value
                    }}
                  </td>

                  <td
                    *ngIf="isFirstLot"
                    [attr.rowspan]="
                      getLotsFormArray(productFormGroup).controls.length
                    "
                  >
                    {{
                      getFormGroup(productFormGroup).get("requestedQuantity")
                        ?.value
                    }}
                  </td>

                  <td
                    *ngIf="isFirstLot"
                    [attr.rowspan]="
                      getLotsFormArray(productFormGroup).controls.length
                    "
                  >
                    {{
                      getFormGroup(productFormGroup).get("approvedQuantity")
                        ?.value
                    }}
                  </td>

                  <td>
                    <div class="flex flex-col">
                      <span>{{
                        getFormGroup(lotGroup).get("batch")?.value
                      }}</span>
                      <span class="text-xs text-gray-400"
                        >Val.:
                        {{
                          getFormGroup(lotGroup).get("expiryDate")?.value
                            | date : "dd/MM/yyyy"
                        }}</span
                      >
                    </div>
                  </td>

                  <td>
                    {{
                      getFormGroup(lotGroup).get("initialLotQuantity")?.value
                    }}
                  </td>

                  <td>
                    <p-inputNumber
                      formControlName="quantityToSeparate"
                      mode="decimal"
                      [min]="0"
                      [max]="
                        getFormGroup(lotGroup).get('initialLotQuantity')?.value
                      "
                      class="w-full"
                      [ngClass]="{
                        'ng-invalid ng-dirty':
                          getFormGroup(lotGroup).get('quantityToSeparate')
                            ?.invalid && formSubmitted
                      }"
                    />
                  </td>
                </tr>
              </ng-container>
            </ng-container>

            <ng-template #simpleProductRow>
              <tr [formGroup]="getFormGroup(productFormGroup)">
                <td>
                  {{ getFormGroup(productFormGroup).get("productName")?.value }}
                </td>

                <td *ngIf="actionType === OrderActionType.Approve">
                  {{
                    getFormGroup(productFormGroup).get("availableQuantity")
                      ?.value
                  }}
                </td>

                <td>
                  {{
                    getFormGroup(productFormGroup).get("requestedQuantity")
                      ?.value
                  }}
                </td>

                <td>
                  <ng-container
                    *ngIf="
                      actionType === OrderActionType.Approve;
                      else approvedQuantityReadonly
                    "
                  >
                    <p-inputNumber
                      formControlName="approvedQuantity"
                      mode="decimal"
                      [min]="0"
                      [max]="
                        getFormGroup(productFormGroup).get('requestedQuantity')
                          ?.value
                      "
                      class="w-full"
                      [ngClass]="{
                        'ng-invalid ng-dirty':
                          getFormGroup(productFormGroup).get('approvedQuantity')
                            ?.invalid && formSubmitted
                      }"
                    />
                  </ng-container>
                  <ng-template #approvedQuantityReadonly>
                    {{
                      getFormGroup(productFormGroup).get("approvedQuantity")
                        ?.value
                    }}
                  </ng-template>
                </td>

                <ng-container *ngIf="actionType === OrderActionType.Separate">
                  <td>N/A</td>
                  <td>N/A</td>
                </ng-container>

                <td
                  *ngIf="
                    actionType === OrderActionType.Separate ||
                    actionType === OrderActionType.Finalize ||
                    actionType === OrderActionType.Detail
                  "
                >
                  <ng-container
                    *ngIf="
                      actionType === OrderActionType.Separate;
                      else actualQuantityReadonly
                    "
                  >
                    <p-inputNumber
                      formControlName="actualQuantity"
                      mode="decimal"
                      [min]="0"
                      [max]="
                        getFormGroup(productFormGroup).get('approvedQuantity')
                          ?.value
                      "
                      class="w-full"
                      [ngClass]="{
                        'ng-invalid ng-dirty':
                          getFormGroup(productFormGroup).get('actualQuantity')
                            ?.invalid && formSubmitted
                      }"
                    />
                  </ng-container>
                  <ng-template #actualQuantityReadonly>
                    {{
                      getFormGroup(productFormGroup).get("actualQuantity")
                        ?.value
                    }}
                  </ng-template>
                </td>
              </tr>
            </ng-template>
          </ng-template>
        </p-table>
      </form>
    </div>
  </ng-container>

  <ng-template pTemplate="footer">
    <div class="flex justify-content-end gap-2">
      <p-button
        *ngIf="actionType !== OrderActionType.Detail"
        [label]="actionType"
        icon="pi pi-check"
        (click)="onActionClick()"
      />

      <p-button
        [label]="actionType === OrderActionType.Detail ? 'Fechar' : 'Cancelar'"
        icon="pi pi-times"
        severity="info"
        [outlined]="true"
        (click)="closeModal()"
      />
    </div>
  </ng-template>
</p-dialog>
